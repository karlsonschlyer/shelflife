<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ShelfLife - Browse Books</title>
  <link rel="stylesheet" href="stylesheet.css" />
  <style>
    .browse-container {
      max-width: 900px;
      margin: 40px auto;
    }
    form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px;
      font-size: 1em;
    }

    /* Book card as a link so it's clickable and accessible */
    .book-card {
      display: block;
      background: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      color: inherit;
      text-decoration: none;
      transition: transform 120ms ease, box-shadow 120ms ease;
    }
    .book-card:hover,
    .book-card:focus {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.12);
      outline: none;
    }
    .book-card h3 {
      margin: 0 0 5px;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 20px;
    }
    .pagination button {
      padding: 6px 12px;
      border: none;
      background: #4b3f72;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .pagination button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    @media (max-width: 600px) {
      .book-card { padding: 12px; }
      form { gap: 8px; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <h1 class="logo">ShelfLife</h1>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a id="login-link" href="login.html">Login</a></li>
        <li><a id="register-link" href="register.html">Register</a></li>
      </ul>
    </div>
  </nav>

  <div class="browse-container">
    <h2>Browse Books</h2>
    <form id="browse-form">
      <!-- Search inputs -->
      <input type="text" id="title" placeholder="Book Title">
      <input type="text" id="author" placeholder="Author Name">
      <input type="text" id="publisher" placeholder="Publisher Name">

      <!-- Filters -->
      <input type="text" id="genre" placeholder="Genre">
      
      <select id="minRating">
        <option value="">Min Rating</option>
        <option value="1">1+</option>
        <option value="2">2+</option>
        <option value="3">3+</option>
        <option value="4">4+</option>
        <option value="5">5</option>
      </select>

      <input type="number" id="minPages" placeholder="Min Pages" min="1">
      <input type="number" id="maxPages" placeholder="Max Pages" min="1">

      <input type="date" id="minDate" placeholder="Earliest Publish Date">
      <input type="date" id="maxDate" placeholder="Latest Publish Date">

      <button type="submit" class="btn">Search</button>
    </form>

    <div id="results" aria-live="polite"></div>

    <div class="pagination">
      <button id="prevBtn" disabled>Previous</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextBtn" disabled>Next</button>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let totalPages = 1;

    function fetchBooks(page = 1) {
      const params = new URLSearchParams();

      const fields = [
        'title', 'author', 'publisher', 'genre',
        'minRating', 'minPages', 'maxPages', 'minDate', 'maxDate'
      ];

      fields.forEach(field => {
        const el = document.getElementById(field);
        if (!el) return;
        const value = el.value.trim();
        if (value) params.append(field, value);
      });

      params.append('page', page);
      params.append('limit', 10); // results per page

      fetch('/browse?' + params.toString())
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.json();
        })
        .then(data => {
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '';

          // support older backends that might return an array directly:
          const items = data.results || data;

          if (!items || items.length === 0) {
            resultsDiv.innerHTML = '<p>No books found.</p>';
          } else {
            items.forEach(book => {
              // Safely parse genres from DB string (e.g. '["Juvenile literature.", "Biography"]')
              let genresList = [];
              try {
                if (book.genres) {
                  genresList = JSON.parse(book.genres);
                }
              } catch (e) {
                // If it's not valid JSON, treat it as a single genre string
                genresList = [book.genres];
              }

              genresList = genresList
                .filter(g => g && g.trim() !== '') // remove null/empty
                .map(g => g.trim().replace(/\.$/, '')); // remove trailing period

              const genresDisplay = genresList.length > 0
                ? genresList.join(', ')
                : 'No Genres Available';
              // create an anchor so clicking / middle-click works naturally
              const card = document.createElement('a');
              card.className = 'book-card';
              card.href = `book.html?isbn=${encodeURIComponent(book.isbn)}`;
              card.innerHTML = `
                <h3>${escapeHtml(book.title || 'Untitled')}</h3>
                <p><strong>Author:</strong> ${escapeHtml(book.author || 'N/A')}</p>
                <p><strong>Publisher:</strong> ${escapeHtml(book.publisher || 'N/A')}</p>
                <p><strong>Genres:</strong> ${escapeHtml(genresDisplay)}</p>
                <p><strong>Pages:</strong> ${book.numPages !== undefined ? escapeHtml(String(book.numPages)) : 'N/A'}</p>
                <p><strong>Rating:</strong> ${book.reviewAverage !== null && book.reviewAverage !== undefined ? escapeHtml(String(book.reviewAverage)) + ' / 5' : 'N/A'}</p>
                <p><strong>Published:</strong> ${book.publishDate ? new Date(book.publishDate).toLocaleDateString() : 'N/A'}</p>
              `;
              // accessibility
              card.setAttribute('role', 'link');
              card.setAttribute('aria-label', (book.title ? book.title : 'Book') + ' â€” view details');

              resultsDiv.appendChild(card);
            });
          }

          // If backend returns object with paging info
          if (data.page !== undefined) {
            currentPage = parseInt(data.page, 10) || 1;
            totalPages = parseInt(data.totalPages, 10) || 1;
          } else {
            // if backend returned plain array, keep paging default
            currentPage = page;
            totalPages = 1;
          }

          document.getElementById('pageInfo').textContent =
            `Page ${currentPage} of ${totalPages}`;

          document.getElementById('prevBtn').disabled = currentPage <= 1;
          document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        })
        .catch(err => {
          console.error('Error fetching books:', err);
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '<p>Error loading books. Try again later.</p>';
        });
    }

    document.getElementById('browse-form').addEventListener('submit', function(e) {
      e.preventDefault();
      currentPage = 1;
      fetchBooks(currentPage);
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) {
        fetchBooks(currentPage - 1);
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentPage < totalPages) {
        fetchBooks(currentPage + 1);
      }
    });

    // Initial load
    fetchBooks();

    // Auth link update
    fetch('/dashboard-data')
      .then(res => {
        if (res.status === 401) {
          document.getElementById('login-link').textContent = 'Login';
          document.getElementById('login-link').href = 'login.html';
          document.getElementById('register-link').style.display = 'inline';
        } else {
          document.getElementById('login-link').textContent = 'Logout';
          document.getElementById('login-link').href = '/logout';
          document.getElementById('register-link').style.display = 'none';
        }
      }).catch(err => {
        console.error('Error fetching dashboard data:', err);
      });

    // tiny helper to avoid injecting raw HTML
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>
